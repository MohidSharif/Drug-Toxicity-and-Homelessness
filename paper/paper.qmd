---
title: "Homelessness and Drug Toxicity"
author: 
  - Gavin Crook
  - Samarth Rajani
  - Mohid Sharif
thanks: "Code and data are available at: https://github.com/MohidSharif/Drug-Toxicity-and-Homelessness.."
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(palmerpenguins)
library(here)
# Turn off echo for all code, disables knitting code chunks
knitr::opts_chunk$set(echo = TRUE)
# Turn off warning messaging in knitted paper file
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
# Import needed libraries
library(kableExtra)

cleaned_data <- read_csv(here::here("data/analysis_data/cleaned_data.csv"))
```


# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....



# Data {#sec-data}

We obtained our data from the City of Toronto **opendatatoronto** database portal, using the 'opendatatoronto' package [@citeopendatatoronto] and the statistical programming language **R** [@citeR]. We used the **tidyverse** package for data manipulation [@citetidyverse] and **kableExtra** for table formatting [@citekableExtra]. The header includes two lines of code **"usepackage{float}"** which allow the use of float in R markdown and the line **"floatplacement{figure}{H}"** [@citeholdposition] which keeps the tables and figures locked in the specific place where they are written in R markdown.

This data set records reports of homeless deaths across Toronto and records the details of the deceased. The data records the **year of death, cause of death, age group, gender, and number of deaths** for every report. The data classifies cases by age group rather than specific ages, age groups are grouped by 20 year age gaps (E.g. "20 to 39 Years") except for the first group which is **"<20"** and the last group which is **"60+"**. Gender is identified and reported as **"Male"** or **"Female"**. Year of death is simply as the year the deaths were reported, starting from **2017** up until **2023**. Cause of deaths are classified as follows: **"Accident", "Cancer", "Cardiovascular Disease", "Covid-19", "Drug Toxicity", "Homicide", "Pneumonia", "Other", "Suicide", and "Unknown/Pending"**. And the number of deaths is simply the number of deaths provided in that report.

Since we are only interested in deaths due to drug toxicity, we simplified the data and created two data sets. First the data was cleaned to remove any **"Unknown"** or **empty** values. Then causes of death due to **Drug Toxicity** were isolated and all others were removed from the data set. We then created two data sets, one highlighting the number of deaths per year for each gender and one for the number of deaths per year for each age group. Since each report in the data set can contain multiple deaths, therefore all counts from each report had to be added to their respective grouping to create a new death count variable for the two data sets. Using these new data sets we can now compare and analyze the death trend over the years for each gender and age group.

@tbl-sample1 shows the data associated with cases reported as "death due to drug toxicity". This data sample shows the number of deaths reported for the years 2017 and 2018 for each age group.

```{r}
#| label: tbl-sample1
#| tbl-cap: Age Group Deaths Due to Drug Toxicity
#| echo: false

# Import knitr
library(knitr)

# Read the data into a variable
age_group_data <- read_csv(here::here("data/analysis_data/age_group_deaths_data.csv"))
gender_data <- read_csv(here::here("data/analysis_data/gender_deaths_data.csv"))

# Filter the data to be specific to data relating to drug txocity causes of death
age_group_data |> 
  select(Year, Age_group, Deaths) |>
# Include 10 listings in the table
  slice(1:8) |> 
# Display the table with appropriate column names and format properties
  kable(
    col.names = c("Year", "Age Group", "Deaths"),
    digits = 1,
    booktabs = TRUE,
    linesep = "") |> 
    kable_styling(latex_options = "HOLD_position")

```

@tbl-sample2 shows the data associated with cases reported as "death due to drug toxicity".This data shows us the number of deaths reported for the years 2017-2020 for each gender.

```{r}
#| label: tbl-sample2
#| tbl-cap: Gender Deaths Due to Drug Toxicity
#| echo: false

# Filter the data to be specific to data relating to drug txocity causes of death
gender_data |> 
  select(Year, Gender, Deaths) |>
# Include 10 listings in the table
  slice(1:8) |> 
# Display the table with appropriate column names and format properties
  kable(
    col.names = c("Year", "Gender", "Deaths"),
    digits = 1,
    booktabs = TRUE,
    linesep = "") |> 
    kable_styling(latex_options = "HOLD_position")

```

@age-graph visualizes our first data of interest, showing deaths per year for each age group. Looking at this graph teaches us a few things. Firstly, homeless aged 40-59 are the most prone to death due to drug intoxication, followed by age group 20-39. Secondly, deaths by intoxication peaked during the years 2020-2022, these years are when the pandemic was most prevelant. Lastly, there seems to be no improvement in the homeless drug problem over this time period.


```{r}
#| label: age-graph
#| fig-cap: Deaths Per Year for Age Group
#| echo: false

# Aggregate data to get the total number of deaths for each year and age group
total_deaths <- cleaned_data %>%
  group_by(Year_of_death, Age_group) %>%
  summarise(Total_Deaths = sum(Count),.groups = "drop")

# Create a bar graph for the total number of deaths
ggplot(total_deaths, aes(x = factor(Year_of_death), y = Total_Deaths, fill = Age_group)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(x = "Year of Death",
       y = "Total Number of Deaths") +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3")) +
  theme_minimal()
```
@gender-graph visualizes our second data set of interest, showing number of deaths for males and females from 2017-2023. We can learn a few more things on top of what @age-graph teaches us. From @gender-graph we can see that men see more deaths due to intoxication than women. We also see a much drastic increase in deaths by drug intoxication for men during the pandemic years compared to women. We also see a large decrease in deaths of women for the year 2023. Overall, we see no improvement in deaths for men, while we only see an improvement for women in the year 2023.

```{r}
#| label: gender-graph
#| fig-cap: Deaths Per Year per Gender
#| echo: false

# Aggregate data to get the total number of deaths for each year and gender
total_deaths_gender <- cleaned_data %>%
  group_by(Year_of_death, Gender) %>%
  summarise(Total_Deaths = sum(Count), .groups = "drop")

# Create a grouped bar graph for male and female
ggplot(total_deaths_gender, aes(x = factor(Year_of_death), y = Total_Deaths, fill = Gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Year of Death",
       y = "Total Number of Deaths") +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62")) +
  theme_minimal()


```
# Model

The goal of our modelling strategy is twofold. Firstly, use a poisson distribution and a negative binomial distribution as we have count data.Both distribution can be use on count data, and by using both we are able to compare results. Secondly, use a multilevel or Bayesian model.

I DO NOTKNOW WHAT TO PUT HERE
Here we briefly describe the Bayesian analysis model used to investigate... Background details and diagnostics are included in [Appendix -@sec-model-details].

## Model set-up   

Define $count_i$ as the count of deaths that resulted from drug toxicity in Toronto. Then $Gender_i$ is the gender for that count of deaths and $Age group_i$ is the range of ages for the deaths.

\begin{align}
\text{Count}_i | \mu_i, \sigma &\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \text{Gender}_i + \text{Age\_group}_i \\
\alpha &\sim \text{Normal}(0, 2.5) \\
\text{Gender} &\sim \text{Normal}(0, 2.5) \\
\text{Age\_group} &\sim \text{Normal}(0, 2.5) \\
\sigma &\sim \text{Exponential}(1)
\end{align}

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.


### Model justification
We expect a their to be a larger relationship between males and the number of deaths. This is because there are more males within the homeless population and more males homeless as a result of addiction to drugs. These reason make it clear that that the male relationship is larger than the female. 

Secondly, we expect the relationship to be larger between younger individuals and the number of deaths. We expect this result as the older individuals who die when homeless, will die of illness like Covid-19 or cancer. This limits the number of deaths occurring as a result of drugs. This may result in a negative relationship for the older age groups and a positive relationship for the younger age groups.


# Results

Our results are summarized in @tbl-modelresults.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(rstanarm)

first_model <-
  readRDS(file = here::here("models/first_model.rds"))

second_model <-
  readRDS(file = here::here("models/second_model.rds"))

third_model <-
  readRDS(file = here::here("models/third_model.rds"))

fourth_model <-
  readRDS(file = here::here("models/fourth_model.rds"))

fifth_model <-
  readRDS(file = here::here("models/fifth_model.rds"))

sixth_model <-
  readRDS(file = here::here("models/sixth_model.rds"))
```

```{r}
#| echo: false
#| eval: true
#| label: tbl-modelresults
#| tbl-cap: "Explanatory models of flight time based on wing width and wing length"
#| warning: false

modelsummary::modelsummary(
  list(
    "Gender Only" = second_model,
    "Age Only" = first_model,
    "Age and Gender" = third_model
  ),
  statistic = "mad",
  fmt = 2
)
```

```{r}
#| echo: false
#| eval: true
#| label: tbl-modelresults2
#| tbl-cap: "Explanatory models of flight time based on wing width and wing length"
#| warning: false


#modelsummary::modelsummary(
#  list(
#    "Gender Only" = fifth_model,
#    "Age Only" = fourth_model,
#    "Age and Gender" = sixth_model
#  ),
#  statistic = "mad",
#  fmt = 2
#)
```

# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}


# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior we implement a posterior predictive check. This shows...

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]

pp_check(first_model) +
  theme_classic() +
  theme(legend.position = "bottom")

#posterior_vs_prior(first_model) +
#  theme_minimal() +
#  scale_color_brewer(palette = "Set1") +
#  theme(legend.position = "bottom") +
#  coord_flip()
```

## Diagnostics

@fig-stanareyouokay is a trace and rhat plot. It shows... This suggests...


```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

plot(first_model, "trace")

plot(first_model, "rhat")
```



\newpage


# References


